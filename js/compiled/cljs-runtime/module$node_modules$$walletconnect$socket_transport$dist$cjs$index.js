shadow$provide.module$node_modules$$walletconnect$socket_transport$dist$cjs$index=function(global,require,module,exports){function getWebSocketUrl(_url,protocol,version){var _a,_b;_url=(_url.startsWith("https")?_url.replace("https","wss"):_url.startsWith("http")?_url.replace("http","ws"):_url).split("?");protocol=utils_1.isBrowser()?{protocol,version,env:"browser",host:(null===(_a=utils_1.getLocation())||void 0===_a?void 0:_a.host)||""}:{protocol,version,env:(null===(_b=utils_1.detectEnv())||void 0===
_b?void 0:_b.name)||""};_a=utils_1.appendToQueryString(utils_1.getQueryString(_url[1]||""),protocol);return _url[0]+"?"+_a}Object.defineProperty(exports,"__esModule",{value:!0});const tslib_1=require("module$node_modules$tslib$tslib"),utils_1=require("module$node_modules$$walletconnect$utils$dist$cjs$index"),network_1=tslib_1.__importDefault(require("module$node_modules$$walletconnect$socket_transport$dist$cjs$network")),WS="undefined"!==typeof global.WebSocket?global.WebSocket:require("module$node_modules$ws$index");
class SocketTransport{constructor(opts){this._queue=[];this._events=[];this._subscriptions=[];this._protocol=opts.protocol;this._version=opts.version;this._url="";this._nextSocket=this._socket=this._netMonitor=null;this._subscriptions=opts.subscriptions||[];this._netMonitor=opts.netMonitor||new network_1.default;if(!opts.url||"string"!==typeof opts.url)throw Error("Missing or invalid WebSocket url");this._url=opts.url;this._netMonitor.on("online",()=>this._socketCreate())}set readyState(value){}get readyState(){return this._socket?
this._socket.readyState:-1}set connecting(value){}get connecting(){return 0===this.readyState}set connected(value){}get connected(){return 1===this.readyState}set closing(value){}get closing(){return 2===this.readyState}set closed(value){}get closed(){return 3===this.readyState}open(){this._socketCreate()}close(){this._socketClose()}send(message,topic,silent){if(!topic||"string"!==typeof topic)throw Error("Missing or invalid topic field");this._socketSend({topic,type:"pub",payload:message,silent:!!silent})}subscribe(topic){this._socketSend({topic,
type:"sub",payload:"",silent:!0})}on(event,callback){this._events.push({event,callback})}_socketCreate(){if(!this._nextSocket){var url=getWebSocketUrl(this._url,this._protocol,this._version);this._nextSocket=new WS(url);if(!this._nextSocket)throw Error("Failed to create socket");this._nextSocket.onmessage=event=>this._socketReceive(event);this._nextSocket.onopen=()=>this._socketOpen();this._nextSocket.onerror=event=>this._socketError(event);this._nextSocket.onclose=()=>{this._nextSocket=null;this._socketCreate()}}}_socketOpen(){this._socketClose();
this._socket=this._nextSocket;this._nextSocket=null;this._queueSubscriptions();this._pushQueue()}_socketClose(){this._socket&&(this._socket.onclose=()=>{},this._socket.close())}_socketSend(socketMessage){const message=JSON.stringify(socketMessage);this._socket&&1===this._socket.readyState?this._socket.send(message):(this._setToQueue(socketMessage),this._socketCreate())}_socketReceive(event$jscomp$0){return tslib_1.__awaiter(this,void 0,void 0,function*(){let socketMessage;try{socketMessage=JSON.parse(event$jscomp$0.data)}catch(error){return}this._socketSend({topic:socketMessage.topic,
type:"ack",payload:"",silent:!0});if(this._socket&&1===this._socket.readyState){const events=this._events.filter(event=>"message"===event.event);events&&events.length&&events.forEach(event=>event.callback(socketMessage))}})}_socketError(e){const events=this._events.filter(event=>"error"===event.event);events&&events.length&&events.forEach(event=>event.callback(e))}_queueSubscriptions(){this._subscriptions.forEach(topic=>this._queue.push({topic,type:"sub",payload:"",silent:!0}));this._subscriptions=
[]}_setToQueue(socketMessage){this._queue.push(socketMessage)}_pushQueue(){this._queue.forEach(socketMessage=>this._socketSend(socketMessage));this._queue=[]}}exports.default=SocketTransport}
//# sourceMappingURL=module$node_modules$$walletconnect$socket_transport$dist$cjs$index.js.map
