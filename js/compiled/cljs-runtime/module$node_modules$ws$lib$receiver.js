shadow$provide.module$node_modules$ws$lib$receiver=function(global,require,module,exports){function error(ErrorCtor,message,prefix,statusCode){ErrorCtor=new ErrorCtor(prefix?`Invalid WebSocket frame: ${message}`:message);Error.captureStackTrace(ErrorCtor,error);ErrorCtor[constants.kStatusCode]=statusCode;return ErrorCtor}function toBuffer(fragments,messageLength){return 1===fragments.length?fragments[0]:1<fragments.length?bufferUtil.concat(fragments,messageLength):constants.EMPTY_BUFFER}var Buffer=
require("module$node_modules$buffer$index").Buffer;"use strict";global=require("module$node_modules$stream_browserify$index");const PerMessageDeflate=require("module$node_modules$ws$lib$permessage_deflate"),bufferUtil=require("module$node_modules$ws$lib$buffer_util"),validation=require("module$node_modules$ws$lib$validation"),constants=require("module$node_modules$ws$lib$constants");class Receiver extends global.Writable{constructor(binaryType,extensions,maxPayload){super();this._binaryType=binaryType||
constants.BINARY_TYPES[0];this[constants.kWebSocket]=void 0;this._extensions=extensions||{};this._maxPayload=maxPayload|0;this._bufferedBytes=0;this._buffers=[];this._compressed=!1;this._payloadLength=0;this._mask=void 0;this._fragmented=0;this._fin=this._masked=!1;this._messageLength=this._totalPayloadLength=this._opcode=0;this._fragments=[];this._state=0;this._loop=!1}_write(chunk,encoding,cb){if(8===this._opcode)return cb();this._bufferedBytes+=chunk.length;this._buffers.push(chunk);this.startLoop(cb)}consume(n){this._bufferedBytes-=
n;if(n===this._buffers[0].length)return this._buffers.shift();if(n<this._buffers[0].length){var buf$jscomp$0=this._buffers[0];this._buffers[0]=buf$jscomp$0.slice(n);return buf$jscomp$0.slice(0,n)}buf$jscomp$0=Buffer.allocUnsafe(n);do{const buf=this._buffers[0];n>=buf.length?this._buffers.shift().copy(buf$jscomp$0,buf$jscomp$0.length-n):(buf.copy(buf$jscomp$0,buf$jscomp$0.length-n,0,n),this._buffers[0]=buf.slice(n));n-=buf.length}while(0<n);return buf$jscomp$0}startLoop(cb){this._loop=!0;do switch(this._state){case 0:var err=
this.getInfo();break;case 1:err=this.getPayloadLength16();break;case 2:err=this.getPayloadLength64();break;case 3:this.getMask();break;case 4:err=this.getData(cb);break;default:this._loop=!1;return}while(this._loop);cb(err)}getInfo(){if(2>this._bufferedBytes)this._loop=!1;else{var buf=this.consume(2);if(0!==(buf[0]&48))return this._loop=!1,error(RangeError,"RSV2 and RSV3 must be clear",!0,1002);var compressed=64===(buf[0]&64);if(compressed&&!this._extensions[PerMessageDeflate.extensionName])return this._loop=
!1,error(RangeError,"RSV1 must be clear",!0,1002);this._fin=128===(buf[0]&128);this._opcode=buf[0]&15;this._payloadLength=buf[1]&127;if(0===this._opcode){if(compressed)return this._loop=!1,error(RangeError,"RSV1 must be clear",!0,1002);if(!this._fragmented)return this._loop=!1,error(RangeError,"invalid opcode 0",!0,1002);this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return this._loop=!1,error(RangeError,`invalid opcode ${this._opcode}`,!0,1002);this._compressed=
compressed}else if(7<this._opcode&&11>this._opcode){if(!this._fin)return this._loop=!1,error(RangeError,"FIN must be set",!0,1002);if(compressed)return this._loop=!1,error(RangeError,"RSV1 must be clear",!0,1002);if(125<this._payloadLength)return this._loop=!1,error(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002)}else return this._loop=!1,error(RangeError,`invalid opcode ${this._opcode}`,!0,1002);this._fin||this._fragmented||(this._fragmented=this._opcode);this._masked=128===(buf[1]&
128);if(126===this._payloadLength)this._state=1;else if(127===this._payloadLength)this._state=2;else return this.haveLength()}}getPayloadLength16(){if(2>this._bufferedBytes)this._loop=!1;else return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength()}getPayloadLength64(){if(8>this._bufferedBytes)this._loop=!1;else{var buf=this.consume(8),num=buf.readUInt32BE(0);if(num>Math.pow(2,21)-1)return this._loop=!1,error(RangeError,"Unsupported WebSocket frame: payload length \x3e 2^53 - 1",
!1,1009);this._payloadLength=num*Math.pow(2,32)+buf.readUInt32BE(4);return this.haveLength()}}haveLength(){if(this._payloadLength&&8>this._opcode&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&0<this._maxPayload))return this._loop=!1,error(RangeError,"Max payload size exceeded",!1,1009);this._state=this._masked?3:4}getMask(){4>this._bufferedBytes?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(cb){var data=constants.EMPTY_BUFFER;if(this._payloadLength){if(this._bufferedBytes<
this._payloadLength){this._loop=!1;return}data=this.consume(this._payloadLength);this._masked&&bufferUtil.unmask(data,this._mask)}if(7<this._opcode)return this.controlMessage(data);if(this._compressed)this._state=5,this.decompress(data,cb);else return data.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(data)),this.dataMessage()}decompress(data,cb){this._extensions[PerMessageDeflate.extensionName].decompress(data,this._fin,(err,buf)=>{if(err)return cb(err);if(buf.length){this._messageLength+=
buf.length;if(this._messageLength>this._maxPayload&&0<this._maxPayload)return cb(error(RangeError,"Max payload size exceeded",!1,1009));this._fragments.push(buf)}if(err=this.dataMessage())return cb(err);this.startLoop(cb)})}dataMessage(){if(this._fin){var messageLength=this._messageLength;const fragments=this._fragments;this._fragmented=this._messageLength=this._totalPayloadLength=0;this._fragments=[];if(2===this._opcode)"nodebuffer"===this._binaryType?messageLength=toBuffer(fragments,messageLength):
"arraybuffer"===this._binaryType?(messageLength=toBuffer(fragments,messageLength),messageLength=0===messageLength.byteOffset&&messageLength.byteLength===messageLength.buffer.byteLength?messageLength.buffer:messageLength.buffer.slice(messageLength.byteOffset,messageLength.byteOffset+messageLength.byteLength)):messageLength=fragments,this.emit("message",messageLength);else{messageLength=toBuffer(fragments,messageLength);if(!validation.isValidUTF8(messageLength))return this._loop=!1,error(Error,"invalid UTF-8 sequence",
!0,1007);this.emit("message",messageLength.toString())}}this._state=0}controlMessage(data){if(8===this._opcode)if(this._loop=!1,0===data.length)this.emit("conclude",1005,""),this.end();else{if(1===data.length)return error(RangeError,"invalid payload length 1",!0,1002);{const code=data.readUInt16BE(0);if(!validation.isValidStatusCode(code))return error(RangeError,`invalid status code ${code}`,!0,1002);data=data.slice(2);if(!validation.isValidUTF8(data))return error(Error,"invalid UTF-8 sequence",!0,
1007);this.emit("conclude",code,data.toString());this.end()}}else 9===this._opcode?this.emit("ping",data):this.emit("pong",data),this._state=0}}module.exports=Receiver}
//# sourceMappingURL=module$node_modules$ws$lib$receiver.js.map
