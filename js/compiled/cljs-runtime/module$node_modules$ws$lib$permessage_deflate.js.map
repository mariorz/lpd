{
"version":3,
"file":"module$node_modules$ws$lib$permessage_deflate.js",
"lineCount":15,
"mappings":"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",
"sources":["node_modules/ws/lib/permessage-deflate.js"],
"sourcesContent":["shadow$provide[\"module$node_modules$ws$lib$permessage_deflate\"] = function(global,require,module,exports) {\nvar process = require('process');\nvar Buffer = require('buffer').Buffer;\n'use strict';\n\nconst Limiter = require('async-limiter');\nconst zlib = require('zlib');\n\nconst bufferUtil = require('./buffer-util');\nconst constants = require('./constants');\n\nconst TRAILER = Buffer.from([0x00, 0x00, 0xff, 0xff]);\nconst EMPTY_BLOCK = Buffer.from([0x00]);\n\nconst kPerMessageDeflate = Symbol('permessage-deflate');\nconst kWriteInProgress = Symbol('write-in-progress');\nconst kPendingClose = Symbol('pending-close');\nconst kTotalLength = Symbol('total-length');\nconst kCallback = Symbol('callback');\nconst kBuffers = Symbol('buffers');\nconst kError = Symbol('error');\n\n//\n// We limit zlib concurrency, which prevents severe memory fragmentation\n// as documented in https://github.com/nodejs/node/issues/8871#issuecomment-250915913\n// and https://github.com/websockets/ws/issues/1202\n//\n// Intentionally global; it's the global thread pool that's an issue.\n//\nlet zlibLimiter;\n\n/**\n * permessage-deflate implementation.\n */\nclass PerMessageDeflate {\n  /**\n   * Creates a PerMessageDeflate instance.\n   *\n   * @param {Object} options Configuration options\n   * @param {Boolean} options.serverNoContextTakeover Request/accept disabling\n   *     of server context takeover\n   * @param {Boolean} options.clientNoContextTakeover Advertise/acknowledge\n   *     disabling of client context takeover\n   * @param {(Boolean|Number)} options.serverMaxWindowBits Request/confirm the\n   *     use of a custom server window size\n   * @param {(Boolean|Number)} options.clientMaxWindowBits Advertise support\n   *     for, or request, a custom client window size\n   * @param {Object} options.zlibDeflateOptions Options to pass to zlib on deflate\n   * @param {Object} options.zlibInflateOptions Options to pass to zlib on inflate\n   * @param {Number} options.threshold Size (in bytes) below which messages\n   *     should not be compressed\n   * @param {Number} options.concurrencyLimit The number of concurrent calls to\n   *     zlib\n   * @param {Boolean} isServer Create the instance in either server or client\n   *     mode\n   * @param {Number} maxPayload The maximum allowed message length\n   */\n  constructor (options, isServer, maxPayload) {\n    this._maxPayload = maxPayload | 0;\n    this._options = options || {};\n    this._threshold = this._options.threshold !== undefined\n      ? this._options.threshold\n      : 1024;\n    this._isServer = !!isServer;\n    this._deflate = null;\n    this._inflate = null;\n\n    this.params = null;\n\n    if (!zlibLimiter) {\n      const concurrency = this._options.concurrencyLimit !== undefined\n        ? this._options.concurrencyLimit\n        : 10;\n      zlibLimiter = new Limiter({ concurrency });\n    }\n  }\n\n  /**\n   * @type {String}\n   */\n  static get extensionName () {\n    return 'permessage-deflate';\n  }\n\n  /**\n   * Create an extension negotiation offer.\n   *\n   * @return {Object} Extension parameters\n   * @public\n   */\n  offer () {\n    const params = {};\n\n    if (this._options.serverNoContextTakeover) {\n      params.server_no_context_takeover = true;\n    }\n    if (this._options.clientNoContextTakeover) {\n      params.client_no_context_takeover = true;\n    }\n    if (this._options.serverMaxWindowBits) {\n      params.server_max_window_bits = this._options.serverMaxWindowBits;\n    }\n    if (this._options.clientMaxWindowBits) {\n      params.client_max_window_bits = this._options.clientMaxWindowBits;\n    } else if (this._options.clientMaxWindowBits == null) {\n      params.client_max_window_bits = true;\n    }\n\n    return params;\n  }\n\n  /**\n   * Accept an extension negotiation offer/response.\n   *\n   * @param {Array} configurations The extension negotiation offers/reponse\n   * @return {Object} Accepted configuration\n   * @public\n   */\n  accept (configurations) {\n    configurations = this.normalizeParams(configurations);\n\n    this.params = this._isServer\n      ? this.acceptAsServer(configurations)\n      : this.acceptAsClient(configurations);\n\n    return this.params;\n  }\n\n  /**\n   * Releases all resources used by the extension.\n   *\n   * @public\n   */\n  cleanup () {\n    if (this._inflate) {\n      if (this._inflate[kWriteInProgress]) {\n        this._inflate[kPendingClose] = true;\n      } else {\n        this._inflate.close();\n        this._inflate = null;\n      }\n    }\n    if (this._deflate) {\n      if (this._deflate[kWriteInProgress]) {\n        this._deflate[kPendingClose] = true;\n      } else {\n        this._deflate.close();\n        this._deflate = null;\n      }\n    }\n  }\n\n  /**\n   *  Accept an extension negotiation offer.\n   *\n   * @param {Array} offers The extension negotiation offers\n   * @return {Object} Accepted configuration\n   * @private\n   */\n  acceptAsServer (offers) {\n    const opts = this._options;\n    const accepted = offers.find((params) => {\n      if (\n        (opts.serverNoContextTakeover === false &&\n          params.server_no_context_takeover) ||\n        (params.server_max_window_bits &&\n          (opts.serverMaxWindowBits === false ||\n            (typeof opts.serverMaxWindowBits === 'number' &&\n              opts.serverMaxWindowBits > params.server_max_window_bits))) ||\n        (typeof opts.clientMaxWindowBits === 'number' &&\n          !params.client_max_window_bits)\n      ) {\n        return false;\n      }\n\n      return true;\n    });\n\n    if (!accepted) {\n      throw new Error('None of the extension offers can be accepted');\n    }\n\n    if (opts.serverNoContextTakeover) {\n      accepted.server_no_context_takeover = true;\n    }\n    if (opts.clientNoContextTakeover) {\n      accepted.client_no_context_takeover = true;\n    }\n    if (typeof opts.serverMaxWindowBits === 'number') {\n      accepted.server_max_window_bits = opts.serverMaxWindowBits;\n    }\n    if (typeof opts.clientMaxWindowBits === 'number') {\n      accepted.client_max_window_bits = opts.clientMaxWindowBits;\n    } else if (\n      accepted.client_max_window_bits === true ||\n      opts.clientMaxWindowBits === false\n    ) {\n      delete accepted.client_max_window_bits;\n    }\n\n    return accepted;\n  }\n\n  /**\n   * Accept the extension negotiation response.\n   *\n   * @param {Array} response The extension negotiation response\n   * @return {Object} Accepted configuration\n   * @private\n   */\n  acceptAsClient (response) {\n    const params = response[0];\n\n    if (\n      this._options.clientNoContextTakeover === false &&\n      params.client_no_context_takeover\n    ) {\n      throw new Error('Unexpected parameter \"client_no_context_takeover\"');\n    }\n\n    if (!params.client_max_window_bits) {\n      if (typeof this._options.clientMaxWindowBits === 'number') {\n        params.client_max_window_bits = this._options.clientMaxWindowBits;\n      }\n    } else if (\n      this._options.clientMaxWindowBits === false ||\n      (typeof this._options.clientMaxWindowBits === 'number' &&\n        params.client_max_window_bits > this._options.clientMaxWindowBits)\n    ) {\n      throw new Error(\n        'Unexpected or invalid parameter \"client_max_window_bits\"'\n      );\n    }\n\n    return params;\n  }\n\n  /**\n   * Normalize parameters.\n   *\n   * @param {Array} configurations The extension negotiation offers/reponse\n   * @return {Array} The offers/response with normalized parameters\n   * @private\n   */\n  normalizeParams (configurations) {\n    configurations.forEach((params) => {\n      Object.keys(params).forEach((key) => {\n        var value = params[key];\n\n        if (value.length > 1) {\n          throw new Error(`Parameter \"${key}\" must have only a single value`);\n        }\n\n        value = value[0];\n\n        if (key === 'client_max_window_bits') {\n          if (value !== true) {\n            const num = +value;\n            if (!Number.isInteger(num) || num < 8 || num > 15) {\n              throw new TypeError(\n                `Invalid value for parameter \"${key}\": ${value}`\n              );\n            }\n            value = num;\n          } else if (!this._isServer) {\n            throw new TypeError(\n              `Invalid value for parameter \"${key}\": ${value}`\n            );\n          }\n        } else if (key === 'server_max_window_bits') {\n          const num = +value;\n          if (!Number.isInteger(num) || num < 8 || num > 15) {\n            throw new TypeError(\n              `Invalid value for parameter \"${key}\": ${value}`\n            );\n          }\n          value = num;\n        } else if (\n          key === 'client_no_context_takeover' ||\n          key === 'server_no_context_takeover'\n        ) {\n          if (value !== true) {\n            throw new TypeError(\n              `Invalid value for parameter \"${key}\": ${value}`\n            );\n          }\n        } else {\n          throw new Error(`Unknown parameter \"${key}\"`);\n        }\n\n        params[key] = value;\n      });\n    });\n\n    return configurations;\n  }\n\n  /**\n   * Decompress data. Concurrency limited by async-limiter.\n   *\n   * @param {Buffer} data Compressed data\n   * @param {Boolean} fin Specifies whether or not this is the last fragment\n   * @param {Function} callback Callback\n   * @public\n   */\n  decompress (data, fin, callback) {\n    zlibLimiter.push((done) => {\n      this._decompress(data, fin, (err, result) => {\n        done();\n        callback(err, result);\n      });\n    });\n  }\n\n  /**\n   * Compress data. Concurrency limited by async-limiter.\n   *\n   * @param {Buffer} data Data to compress\n   * @param {Boolean} fin Specifies whether or not this is the last fragment\n   * @param {Function} callback Callback\n   * @public\n   */\n  compress (data, fin, callback) {\n    zlibLimiter.push((done) => {\n      this._compress(data, fin, (err, result) => {\n        done();\n        callback(err, result);\n      });\n    });\n  }\n\n  /**\n   * Decompress data.\n   *\n   * @param {Buffer} data Compressed data\n   * @param {Boolean} fin Specifies whether or not this is the last fragment\n   * @param {Function} callback Callback\n   * @private\n   */\n  _decompress (data, fin, callback) {\n    const endpoint = this._isServer ? 'client' : 'server';\n\n    if (!this._inflate) {\n      const key = `${endpoint}_max_window_bits`;\n      const windowBits = typeof this.params[key] !== 'number'\n        ? zlib.Z_DEFAULT_WINDOWBITS\n        : this.params[key];\n\n      this._inflate = zlib.createInflateRaw(\n        Object.assign({}, this._options.zlibInflateOptions, { windowBits })\n      );\n      this._inflate[kPerMessageDeflate] = this;\n      this._inflate[kTotalLength] = 0;\n      this._inflate[kBuffers] = [];\n      this._inflate.on('error', inflateOnError);\n      this._inflate.on('data', inflateOnData);\n    }\n\n    this._inflate[kCallback] = callback;\n    this._inflate[kWriteInProgress] = true;\n\n    this._inflate.write(data);\n    if (fin) this._inflate.write(TRAILER);\n\n    this._inflate.flush(() => {\n      const err = this._inflate[kError];\n\n      if (err) {\n        this._inflate.close();\n        this._inflate = null;\n        callback(err);\n        return;\n      }\n\n      const data = bufferUtil.concat(\n        this._inflate[kBuffers],\n        this._inflate[kTotalLength]\n      );\n\n      if (\n        (fin && this.params[`${endpoint}_no_context_takeover`]) ||\n        this._inflate[kPendingClose]\n      ) {\n        this._inflate.close();\n        this._inflate = null;\n      } else {\n        this._inflate[kWriteInProgress] = false;\n        this._inflate[kTotalLength] = 0;\n        this._inflate[kBuffers] = [];\n      }\n\n      callback(null, data);\n    });\n  }\n\n  /**\n   * Compress data.\n   *\n   * @param {Buffer} data Data to compress\n   * @param {Boolean} fin Specifies whether or not this is the last fragment\n   * @param {Function} callback Callback\n   * @private\n   */\n  _compress (data, fin, callback) {\n    if (!data || data.length === 0) {\n      process.nextTick(callback, null, EMPTY_BLOCK);\n      return;\n    }\n\n    const endpoint = this._isServer ? 'server' : 'client';\n\n    if (!this._deflate) {\n      const key = `${endpoint}_max_window_bits`;\n      const windowBits = typeof this.params[key] !== 'number'\n        ? zlib.Z_DEFAULT_WINDOWBITS\n        : this.params[key];\n\n      this._deflate = zlib.createDeflateRaw(\n        Object.assign(\n          // TODO deprecate memLevel/level and recommend zlibDeflateOptions instead\n          {\n            memLevel: this._options.memLevel,\n            level: this._options.level\n          },\n          this._options.zlibDeflateOptions,\n          { windowBits }\n        )\n      );\n\n      this._deflate[kTotalLength] = 0;\n      this._deflate[kBuffers] = [];\n\n      //\n      // `zlib.DeflateRaw` emits an `'error'` event only when an attempt to use\n      // it is made after it has already been closed. This cannot happen here,\n      // so we only add a listener for the `'data'` event.\n      //\n      this._deflate.on('data', deflateOnData);\n    }\n\n    this._deflate[kWriteInProgress] = true;\n\n    this._deflate.write(data);\n    this._deflate.flush(zlib.Z_SYNC_FLUSH, () => {\n      var data = bufferUtil.concat(\n        this._deflate[kBuffers],\n        this._deflate[kTotalLength]\n      );\n\n      if (fin) data = data.slice(0, data.length - 4);\n\n      if (\n        (fin && this.params[`${endpoint}_no_context_takeover`]) ||\n        this._deflate[kPendingClose]\n      ) {\n        this._deflate.close();\n        this._deflate = null;\n      } else {\n        this._deflate[kWriteInProgress] = false;\n        this._deflate[kTotalLength] = 0;\n        this._deflate[kBuffers] = [];\n      }\n\n      callback(null, data);\n    });\n  }\n}\n\nmodule.exports = PerMessageDeflate;\n\n/**\n * The listener of the `zlib.DeflateRaw` stream `'data'` event.\n *\n * @param {Buffer} chunk A chunk of data\n * @private\n */\nfunction deflateOnData (chunk) {\n  this[kBuffers].push(chunk);\n  this[kTotalLength] += chunk.length;\n}\n\n/**\n * The listener of the `zlib.InflateRaw` stream `'data'` event.\n *\n * @param {Buffer} chunk A chunk of data\n * @private\n */\nfunction inflateOnData (chunk) {\n  this[kTotalLength] += chunk.length;\n\n  if (\n    this[kPerMessageDeflate]._maxPayload < 1 ||\n    this[kTotalLength] <= this[kPerMessageDeflate]._maxPayload\n  ) {\n    this[kBuffers].push(chunk);\n    return;\n  }\n\n  this[kError] = new RangeError('Max payload size exceeded');\n  this[kError][constants.kStatusCode] = 1009;\n  this.removeListener('data', inflateOnData);\n  this.reset();\n}\n\n/**\n * The listener of the `zlib.InflateRaw` stream `'error'` event.\n *\n * @param {Error} err The emitted error\n * @private\n */\nfunction inflateOnError (err) {\n  //\n  // There is no need to call `Zlib#close()` as the handle is automatically\n  // closed when an error is emitted.\n  //\n  this[kPerMessageDeflate]._inflate = null;\n  err[constants.kStatusCode] = 1007;\n  this[kCallback](err);\n}\n\n};"],
"names":["shadow$provide","global","require","module","exports","deflateOnData","chunk","kBuffers","push","kTotalLength","length","inflateOnData","kPerMessageDeflate","_maxPayload","kError","RangeError","constants","kStatusCode","removeListener","reset","inflateOnError","err","_inflate","kCallback","process","Buffer","Limiter","zlib","bufferUtil","TRAILER","from","EMPTY_BLOCK","Symbol","kWriteInProgress","kPendingClose","zlibLimiter","PerMessageDeflate","constructor","options","isServer","maxPayload","_options","_threshold","undefined","threshold","_isServer","params","_deflate","concurrency","concurrencyLimit","offer","serverNoContextTakeover","server_no_context_takeover","clientNoContextTakeover","client_no_context_takeover","serverMaxWindowBits","server_max_window_bits","clientMaxWindowBits","client_max_window_bits","accept","configurations","normalizeParams","acceptAsServer","acceptAsClient","cleanup","close","offers","opts","accepted","find","Error","response","forEach","Object","keys","key","value","num","Number","isInteger","TypeError","decompress","data","fin","callback","done","_decompress","result","compress","_compress","endpoint","createInflateRaw","assign","zlibInflateOptions","windowBits","Z_DEFAULT_WINDOWBITS","on","write","flush","concat","createDeflateRaw","memLevel","level","zlibDeflateOptions","Z_SYNC_FLUSH","slice","nextTick"]
}
