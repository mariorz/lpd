shadow$provide.module$node_modules$ws$lib$permessage_deflate=function(global,require,module,exports){function deflateOnData(chunk){this[kBuffers].push(chunk);this[kTotalLength]+=chunk.length}function inflateOnData(chunk){this[kTotalLength]+=chunk.length;1>this[kPerMessageDeflate]._maxPayload||this[kTotalLength]<=this[kPerMessageDeflate]._maxPayload?this[kBuffers].push(chunk):(this[kError]=new RangeError("Max payload size exceeded"),this[kError][constants.kStatusCode]=1009,this.removeListener("data",
inflateOnData),this.reset())}function inflateOnError(err){this[kPerMessageDeflate]._inflate=null;err[constants.kStatusCode]=1007;this[kCallback](err)}var process=require("module$node_modules$process$browser");global=require("module$node_modules$buffer$index").Buffer;"use strict";const Limiter=require("module$node_modules$async_limiter$index"),zlib=require("module$node_modules$browserify_zlib$lib$index"),bufferUtil=require("module$node_modules$ws$lib$buffer_util"),constants=require("module$node_modules$ws$lib$constants"),
TRAILER=global.from([0,0,255,255]),EMPTY_BLOCK=global.from([0]),kPerMessageDeflate=Symbol("permessage-deflate"),kWriteInProgress=Symbol("write-in-progress"),kPendingClose=Symbol("pending-close"),kTotalLength=Symbol("total-length"),kCallback=Symbol("callback"),kBuffers=Symbol("buffers"),kError=Symbol("error");let zlibLimiter;class PerMessageDeflate{constructor(options,isServer,maxPayload){this._maxPayload=maxPayload|0;this._options=options||{};this._threshold=void 0!==this._options.threshold?this._options.threshold:
1024;this._isServer=!!isServer;this.params=this._inflate=this._deflate=null;zlibLimiter||(zlibLimiter=new Limiter({concurrency:void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10}))}static get extensionName(){return"permessage-deflate"}offer(){const params={};this._options.serverNoContextTakeover&&(params.server_no_context_takeover=!0);this._options.clientNoContextTakeover&&(params.client_no_context_takeover=!0);this._options.serverMaxWindowBits&&(params.server_max_window_bits=
this._options.serverMaxWindowBits);this._options.clientMaxWindowBits?params.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(params.client_max_window_bits=!0);return params}accept(configurations){configurations=this.normalizeParams(configurations);return this.params=this._isServer?this.acceptAsServer(configurations):this.acceptAsClient(configurations)}cleanup(){this._inflate&&(this._inflate[kWriteInProgress]?this._inflate[kPendingClose]=!0:(this._inflate.close(),
this._inflate=null));this._deflate&&(this._deflate[kWriteInProgress]?this._deflate[kPendingClose]=!0:(this._deflate.close(),this._deflate=null))}acceptAsServer(offers){const opts=this._options;offers=offers.find(params=>!1===opts.serverNoContextTakeover&&params.server_no_context_takeover||params.server_max_window_bits&&(!1===opts.serverMaxWindowBits||"number"===typeof opts.serverMaxWindowBits&&opts.serverMaxWindowBits>params.server_max_window_bits)||"number"===typeof opts.clientMaxWindowBits&&!params.client_max_window_bits?
!1:!0);if(!offers)throw Error("None of the extension offers can be accepted");opts.serverNoContextTakeover&&(offers.server_no_context_takeover=!0);opts.clientNoContextTakeover&&(offers.client_no_context_takeover=!0);"number"===typeof opts.serverMaxWindowBits&&(offers.server_max_window_bits=opts.serverMaxWindowBits);"number"===typeof opts.clientMaxWindowBits?offers.client_max_window_bits=opts.clientMaxWindowBits:(!0===offers.client_max_window_bits||!1===opts.clientMaxWindowBits)&&delete offers.client_max_window_bits;
return offers}acceptAsClient(response){response=response[0];if(!1===this._options.clientNoContextTakeover&&response.client_no_context_takeover)throw Error('Unexpected parameter "client_no_context_takeover"');if(!response.client_max_window_bits)"number"===typeof this._options.clientMaxWindowBits&&(response.client_max_window_bits=this._options.clientMaxWindowBits);else if(!1===this._options.clientMaxWindowBits||"number"===typeof this._options.clientMaxWindowBits&&response.client_max_window_bits>this._options.clientMaxWindowBits)throw Error('Unexpected or invalid parameter "client_max_window_bits"');
return response}normalizeParams(configurations){configurations.forEach(params=>{Object.keys(params).forEach(key=>{var value=params[key];if(1<value.length)throw Error(`Parameter "${key}" must have only a single value`);value=value[0];if("client_max_window_bits"===key)if(!0!==value){var num=+value;if(!Number.isInteger(num)||8>num||15<num)throw new TypeError(`Invalid value for parameter "${key}": ${value}`);value=num}else{if(!this._isServer)throw new TypeError(`Invalid value for parameter "${key}": ${value}`);
}else if("server_max_window_bits"===key){num=+value;if(!Number.isInteger(num)||8>num||15<num)throw new TypeError(`Invalid value for parameter "${key}": ${value}`);value=num}else if("client_no_context_takeover"===key||"server_no_context_takeover"===key){if(!0!==value)throw new TypeError(`Invalid value for parameter "${key}": ${value}`);}else throw Error(`Unknown parameter "${key}"`);params[key]=value})});return configurations}decompress(data,fin,callback){zlibLimiter.push(done=>{this._decompress(data,
fin,(err,result)=>{done();callback(err,result)})})}compress(data,fin,callback){zlibLimiter.push(done=>{this._compress(data,fin,(err,result)=>{done();callback(err,result)})})}_decompress(data,fin,callback){const endpoint=this._isServer?"client":"server";if(!this._inflate){const key=`${endpoint}_max_window_bits`;this._inflate=zlib.createInflateRaw(Object.assign({},this._options.zlibInflateOptions,{windowBits:"number"!==typeof this.params[key]?zlib.Z_DEFAULT_WINDOWBITS:this.params[key]}));this._inflate[kPerMessageDeflate]=
this;this._inflate[kTotalLength]=0;this._inflate[kBuffers]=[];this._inflate.on("error",inflateOnError);this._inflate.on("data",inflateOnData)}this._inflate[kCallback]=callback;this._inflate[kWriteInProgress]=!0;this._inflate.write(data);fin&&this._inflate.write(TRAILER);this._inflate.flush(()=>{var err=this._inflate[kError];err?(this._inflate.close(),this._inflate=null,callback(err)):(err=bufferUtil.concat(this._inflate[kBuffers],this._inflate[kTotalLength]),fin&&this.params[`${endpoint}_no_context_takeover`]||
this._inflate[kPendingClose]?(this._inflate.close(),this._inflate=null):(this._inflate[kWriteInProgress]=!1,this._inflate[kTotalLength]=0,this._inflate[kBuffers]=[]),callback(null,err))})}_compress(data$jscomp$0,fin,callback){if(data$jscomp$0&&0!==data$jscomp$0.length){var endpoint=this._isServer?"server":"client";if(!this._deflate){const key=`${endpoint}_max_window_bits`;this._deflate=zlib.createDeflateRaw(Object.assign({memLevel:this._options.memLevel,level:this._options.level},this._options.zlibDeflateOptions,
{windowBits:"number"!==typeof this.params[key]?zlib.Z_DEFAULT_WINDOWBITS:this.params[key]}));this._deflate[kTotalLength]=0;this._deflate[kBuffers]=[];this._deflate.on("data",deflateOnData)}this._deflate[kWriteInProgress]=!0;this._deflate.write(data$jscomp$0);this._deflate.flush(zlib.Z_SYNC_FLUSH,()=>{var data=bufferUtil.concat(this._deflate[kBuffers],this._deflate[kTotalLength]);fin&&(data=data.slice(0,data.length-4));fin&&this.params[`${endpoint}_no_context_takeover`]||this._deflate[kPendingClose]?
(this._deflate.close(),this._deflate=null):(this._deflate[kWriteInProgress]=!1,this._deflate[kTotalLength]=0,this._deflate[kBuffers]=[]);callback(null,data)})}else process.nextTick(callback,null,EMPTY_BLOCK)}}module.exports=PerMessageDeflate}
//# sourceMappingURL=module$node_modules$ws$lib$permessage_deflate.js.map
